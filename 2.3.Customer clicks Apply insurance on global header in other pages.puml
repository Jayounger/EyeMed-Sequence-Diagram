@startuml
title Customer clicks Apply insurance on global header in other pages
actor Customer
participant FE #abcaff
participant "Direct Billing Bundle UI" #c3ffcd
participant "Webservice" #abcaff
participant "Commerce Insurance" #abcaff
participant "Commerce Customer" #abcaff
participant "2019" #abcaff
participant "Direct Billing Backend" #c3ffcd
database "Redis" #yellow
database "Mysql" #fdda14

autonumber
Customer -> "Direct Billing Bundle UI":User fills in the insurance account and clicks the "Apply insurance"

"Direct Billing Bundle UI" -> FE:Hook function getCartItemDetails

FE -> "Webservice":GET /insurances/cart-products
"Webservice" -> "Commerce Insurance":GET /insurances/cart-products
"Commerce Insurance" -> 2019:GET /cart
2019 --> "Commerce Insurance":Response
"Commerce Insurance" --> "Webservice":Response
"Webservice" --> FE:Response
FE --> "Direct Billing Bundle UI":Response product bundle

"Direct Billing Bundle UI" -> "Direct Billing Backend": PUT /claim-records

alt If quote has applied
    "Direct Billing Backend" -> "Webservice":POST /update-insurance-details <font color=#27ad9a>QUOTE_APPLIED
    "Webservice" -> "Commerce Insurance":POST /insurances/cart-insurance-details
    "Commerce Insurance" -> "Mysql":Insert insurance details
    "Mysql" --> "Commerce Insurance":Response
    "Commerce Insurance" --> "Webservice":Response
    "Webservice" --> "Direct Billing Backend":Response
    "Direct Billing Backend" --> "Direct Billing Bundle UI":Insurance toggle status is synced
    "Direct Billing Bundle UI" -> FE:Hook function refreshCart
    FE -> FE:Update the discount price on quick cart
else If quote has not applied
    "Direct Billing Backend" --> "Direct Billing Bundle UI":Insurance toggle status is synced
    "Direct Billing Bundle UI" -> FE:Hook function refreshCart <font color=red>???
    FE -> FE:Update the discount price on quick cart <font color=red>???
end
@enduml

